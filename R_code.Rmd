---
title: "R-code for 'Tolerability of atovaquone-proguanil application in common buzzards'"
author: "Anja Wiegmann, Tony Rinaud, Meinolf Ottensmann, Oliver Krüger, Andrea Springer, Marko Legler, Michael Fehr, Christina Strube and Nayden Chakarov"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, tidy=TRUE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document provides all the `R code` used in our paper. Both the Rmarkdown file and the data can be downloaded from the accompanying GitHub repository on (https://github.com/TonyRinaud/malarone_tolerability) as a zip archive containing all the files. We recommend to download or clone this [GitHub repository](https://github.com/TonyRinaud/malarone_tolerability) in order to access the documentation together with all the files that are needed to repeat analyses shown in this document. Just click on the link above and then on the green box `Clone or download`. In order to function properly, the same structure of folders must be kept. If you have any questions, don't hesitate to contact tony.rinaud[at]uni-bielefeld.de or m.ottensmann[at]uni-bielefeld.de

In order to repeat analyses presented in this document, the following packages are required. 

```{r packages, message=F, warning=F}
## Load packages
## -----------------------------------------------------------------------------
easypackages::libraries(
  "tidyverse", "lme4", "chron", "patchwork",
  "magrittr", "readr", "EnvStats", "sjPlot", "egg","ggplot2","dplyr") 
```

## Loading raw datasets

* `Malarone® experiment`

Experimental study comprising data from 299 nestlings that were either treated with Malarone® or water. An additional subset comprises individuals that received no treatment and were therefore only exposed to repeated routine sampling and handling. 


```{r echo = TRUE, warning=FALSE}
## Read and format raw data: (saved raw data with "." as decimal operator)
## -----------------------------------------------------------------------------
malarone.data <- readr::read_delim(
  file = 'data/malarone_tolerability.csv', delim = ";", col_types = "fffffffinnnnnnnnnnnffff") %>% 
  mutate(Treatment = case_when(Treatment == "Control" ~ "control",
                               Treatment == "Water" ~ "water",
                               Treatment == "Malarone" ~ "Malarone®")) %>% 
  mutate(Treatment = factor(Treatment, levels = c("control","water","Malarone®"))) %>% 
  ## Scaling continuous variables
  mutate(delta_body_condition = scale(delta_body_condition)) %>% 
  mutate(body_condition.1 = scale(body_condition.1)) %>% 
  mutate(body_condition.2 = scale(body_condition.2)) %>% 
  mutate(growth_rate = scale(growth_rate))
```

* `Bloodchemistry data`

Dataset on blood chemistry values for 11 individuals of the `Malarone® experiment` prior and after treatment. Additionally, blood chemistry values for another 60 individuals that were not part of the `Malarone® experiment`.


```{r}
bloodchem.data <- readr::read_csv(file = "data/bloodchemistry_data.csv") %>% 
  mutate(Ring = as.character(Ring)) %>% 
  mutate(Treatment = factor(Treatment,
                            levels = c("Pre-Control", "Post-Control", "Pre-Mal", "Post-Mal"))) %>% 
  mutate(doy = lubridate::yday(Date)) 
names(bloodchem.data)[names(bloodchem.data) == "Lprev"] <- "Leucocytozoon"

## Some gGT values are at boundaries, set those to 5
## -----------------------------------------------------------------------------
bloodchem.data$GGT[bloodchem.data$GGT == "<5"] <- 5
bloodchem.data$GGT <- as.numeric(bloodchem.data$GGT)

## Summarise sample sizes
## -----------------------------------------------------------------------------
pander::pandoc.table(table(bloodchem.data$Treatment))
```

## Analyses
### `Experimental data`

#### Data summary

```{r}
## Sample size per treatment and year
with(malarone.data, table(Year, Treatment))
quantile(malarone.data$avg_age)
quantile(malarone.data$days_resample)
```

* Visualise distribution of age at sampling for each treatment level

```{r}
## Create data frame with data on both sampling occasion 
## -----------------------------------------------------------------------------
summary.df <- data.frame(
  Treatment = rep(malarone.data$Treatment, 2),
  Age = c(malarone.data$Age.1, malarone.data$Age.2),
  Ring = rep(malarone.data$Ring, 2),
  Wing = c(malarone.data$Wing.1, malarone.data$Wing.2),
  Weight = c(malarone.data$Weight.1, malarone.data$Weight.2),
  Sampling = rep(c("First sample", "Second sample"), each = 299),
  Sex = rep(malarone.data$Sex,2))

## Summarise Age at sampling
## -----------------------------------------------------------------------------
summary.df %>% 
  group_by(Treatment, Sampling) %>%
  summarise(MEAN = mean(Age),
            SD = sd(Age),
            Min = min(Age),
            Max = max(Age),
            LCL = quantile(Age, 0.025),
            UCL = quantile(Age, 0.975))

## Summarise Weight at sampling 
## -----------------------------------------------------------------------------
summary.df %>% 
  group_by(Treatment, Sampling) %>%
  summarise(MEAN = mean(Weight),
            SD = sd(Weight),
            Min = min(Weight),
            Max = max(Weight),
            LCL = quantile(Weight, 0.025),
            UCL = quantile(Weight, 0.975))

## Plot distributions
## -----------------------------------------------------------------------------
ggplot(summary.df, aes(x = Sampling, y = Age, col = Treatment)) +
  theme_article(base_size = 10) +
  theme(legend.position = "bottom") +
  geom_boxplot(position = position_dodge2(width = .5)) +
  scale_y_continuous(breaks = seq(5, 40, 5)) +
  ylab("Nestling age (days)") +
  xlab("Sampling ocassion")
```

* Visualise regression of body weight on wing length as measure of body condition

To explore the potential of treatment-specific effects on growth parameters, we next visualise the regression of body weight on wing length. For comparison, we include reference data that has been obtained for nestlings of known hatching dates (Bijlsma 1999, Limosa 72, Appendices 1 - 2).

```{r}
## read reference dataset
## -----------------------------------------------------------------------------
bijlsma <- read.csv("data/bijlsma_1999_Limosa_72.csv")
head(bijlsma)
tail(bijlsma)

## visualise sex-specific condition curves
## -----------------------------------------------------------------------------
ggplot(bijlsma, aes(x = wing, y =  weight, shape = sex, col = sex)) +
  geom_point(size = 1, na.rm = T) +
  geom_smooth(method = "lm", na.rm = T, formula = "y ~ x", se = F) +
  theme_article() +
  theme(legend.position = c(1,0),
        legend.justification = c(1,0)) +
  scale_x_log10(breaks = seq(0, 35, 5)) +
  ylab("Mean body weight [g]") +
  xlab("Wing length [cm]") +
  labs(title = "Body condition of buzzard nestlings",
       caption = "Data: Bijlsma 1999, Limosa 72")

## obtain formula for age-specific regression lines
## -----------------------------------------------------------------------------
female <- lm(weight ~ log10(wing), data = bijlsma[bijlsma$sex == "Female",])
summary(female)
female$coefficients

male <- lm(weight ~ log10(wing), data = bijlsma[bijlsma$sex == "Male",])
summary(male)
male$coefficients
```

* Establish growth curves for all treatment x sex combinations (n=6)

```{r}
## define all combinations
## -----------------------------------------------------------------------------
combinations <- data.frame(Treatment = rep(c("control", "Malarone®", "water"), each = 2),
                           Sex = rep(c("Female", "Male"), 3))

## fit models 
## -----------------------------------------------------------------------------
models <- lapply(1:nrow(combinations), function(x) {
  model <- lmer(Weight ~ log10(Wing) + (1|Ring),
                data = filter(summary.df, 
                              Treatment == combinations$Treatment[x],
                              Sex == combinations$Sex[x]))
  data.frame(Treatment = combinations$Treatment[x],
             Sex = combinations$Sex[x],
             Intercept = summary(model)$coefficients[1,1],
             Slope = summary(model)$coefficients[2,1],
             R2.marg = performance::model_performance(model)[4],
             R2.cond = performance::model_performance(model)[3])

}) %>% 
  do.call("rbind",.)
models
```


* Adding reference data to raw data points from the current study

```{r}
 ## Male control
## -----------------------------------------------------------------------------
m.c <- 
  ggplot(filter(summary.df, Sex == "Male", Treatment == "control"),
         aes(x = Wing, y =  Weight)) +
  geom_abline(intercept = male$coefficients[1], slope = male$coefficients[2],
              lty = 4, size = 1.1) +
  geom_abline(intercept = models$Intercept[2], slope = models$Slope[2],
              lty = 1, size = 1.1, col = "#1F78B4") +
  geom_point(size = 1.5, alpha = .6, aes(shape = Sampling), col = "#1F78B4") +
  guides(col = "none") +
  theme_article() + 
  theme(legend.position = "none",
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank()) +
  ylab("Body weight (g)") +
  labs(subtitle = "control") +
  scale_y_continuous(breaks = seq(0, 1000, 200), limits = c(150, 1050)) +
  scale_x_log10(breaks = seq(0, 30, 5), limits = c(3.8, 30.1)) +
  geom_text(data = data.frame(Wing = Inf, Weight = Inf, Treatment = "control"),
            label = paste("R² (marg.)=", round(models$R2_marginal[2],2)),
            hjust = 1.015, vjust = 1.5, col = "Black") +
  geom_text(data = data.frame(Wing = 3.9, Weight = Inf, Treatment = "control"),
            label = "\U2642", hjust = 0, vjust = 1.5, col = "Black", size = 8)

## Male Malarone®
## -----------------------------------------------------------------------------
m.m <- 
  ggplot(filter(summary.df, Sex == "Male", Treatment == "Malarone®"),
         aes(x = Wing, y =  Weight)) +
  geom_abline(intercept = male$coefficients[1], slope = male$coefficients[2],
              lty = 4, size = 1.1) +
  geom_abline(intercept = models$Intercept[4], slope = models$Slope[4],
              lty = 1, size = 1.1, col = "#33A02C") +
  geom_point(size = 1.5, alpha = .6, aes(shape = Sampling), col = "#33A02C") +
  guides(col = "none") +
  labs(subtitle = "Malarone®") +
  theme_article() + 
  theme(legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank()) +
  scale_y_continuous(breaks = seq(0, 1000, 200), limits = c(150, 1050)) +
  scale_x_log10(breaks = seq(0, 30, 5), limits = c(3.8, 30.1)) +
  geom_text(data = data.frame(Wing = Inf, Weight = Inf, Treatment = "control"),
            label = paste("R² (marg.)=", round(models$R2_marginal[4],2)),
            hjust = 1.015, vjust = 1.5, col = "Black") 

## Male water
## -----------------------------------------------------------------------------
m.w <- 
  ggplot(filter(summary.df, Sex == "Male", Treatment == "water"),
         aes(x = Wing, y =  Weight)) +
  geom_abline(intercept = male$coefficients[1], slope = male$coefficients[2],
              lty = 4, size = 1.1) +
  geom_abline(intercept = models$Intercept[6], slope = models$Slope[6],
              lty = 1, size = 1.1, col = "#FF7F00") +
  geom_point(size = 1.5, alpha = .6, aes(shape = Sampling), col = "#FF7F00") +
  guides(col = "none") +
  labs(subtitle = "water") +
  theme_article() + 
  theme(legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank()) +
  scale_y_continuous(breaks = seq(0, 1000, 200), limits = c(150, 1050)) +
  scale_x_log10(breaks = seq(0, 30, 5), limits = c(3.8, 30.1)) +
  geom_text(data = data.frame(Wing = Inf, Weight = Inf, Treatment = "control"),
            label = paste("R² (marg.)=", round(models$R2_marginal[6],2)),
            hjust = 1.015, vjust = 1.5, col = "Black") 

## Female control
## -----------------------------------------------------------------------------
f.c <- 
  ggplot(filter(summary.df, Sex == "Female", Treatment == "control"),
         aes(x = Wing, y =  Weight)) +
  geom_abline(intercept = female$coefficients[1], slope = female$coefficients[2],
              lty = 4, size = 1.1) +
  geom_abline(intercept = models$Intercept[1], slope = models$Slope[1],
              lty = 1, size = 1.1, col = "#1F78B4") +
  geom_point(size = 1.5, alpha = .6, aes(shape = Sampling), col = "#1F78B4") +
  guides(col = "none") +
  theme_article() + 
  theme(legend.position = "none",
        axis.title.x = element_blank()) +
  ylab("Body weight (g)") +
  scale_y_continuous(breaks = seq(0, 1000, 200), limits = c(150, 1050)) +
  scale_x_log10(breaks = seq(0, 30, 5), limits = c(3.8, 30.1)) +
  geom_text(data = data.frame(Wing = Inf, Weight = Inf, Treatment = "control"),
            label = paste("R² (marg.)=", round(models$R2_marginal[1],2)), 
            hjust = 1.015, vjust = 1.5, col = "Black") +
  geom_text(data = data.frame(Wing = 3.9, Weight = Inf, Treatment = "control"),
            label = "\U2640", hjust = 0, vjust = 1.5, col = "Black", size = 8) 

## Female Malarone®
## -----------------------------------------------------------------------------
f.m <- 
  ggplot(filter(summary.df, Sex == "Female", Treatment == "Malarone®"),
         aes(x = Wing, y =  Weight)) +
  geom_abline(intercept = female$coefficients[1], slope = female$coefficients[2],
              lty = 4, size = 1.1) +
  geom_abline(intercept = models$Intercept[3], slope = models$Slope[3],
              lty = 1, size = 1.1, col = "#33A02C") +
  geom_point(size = 1.5, alpha = .6, aes(shape = Sampling), col = "#33A02C") +
  guides(col = "none") +
  theme_article() + 
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("Wing length (cm)") +
  scale_y_continuous(breaks = seq(0, 1000, 200), limits = c(150, 1050)) +
  scale_x_log10(breaks = seq(0, 30, 5), limits = c(3.8, 30.1)) +
  geom_text(data = data.frame(Wing = Inf, Weight = Inf, Treatment = "control"),
            label = paste("R² (marg.)=", round(models$R2_marginal[3],2)),
            hjust = 1.015, vjust = 1.5, col = "Black") 

## Female water
## -----------------------------------------------------------------------------
f.w <- 
  ggplot(filter(summary.df, Sex == "Female", Treatment == "water"),
         aes(x = Wing, y =  Weight)) +
  geom_abline(intercept = female$coefficients[1], slope = female$coefficients[2],
              lty = 4, size = 1.1) +
  geom_abline(intercept = models$Intercept[5], slope = models$Slope[5],
              lty = 1, size = 1.1, col = "#FF7F00") +
  geom_point(size = 1.5, alpha = .6, aes(shape = Sampling), col = "#FF7F00") +
  guides(fill = "none") +
  theme_article() + 
  theme(
    axis.title = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    strip.text = element_blank(),
    legend.position = c(1,0),
    legend.justification = c(1,0),
    legend.title = element_blank()) +
  scale_y_continuous(breaks = seq(0, 1000, 200), limits = c(150, 1050)) +
  scale_x_log10(breaks = seq(0, 30, 5), limits = c(3.8, 30.1)) +
  geom_text(data = data.frame(Wing = Inf, Weight = Inf, Treatment = "control"),
            label = paste("R² (marg.)=", round(models$R2_marginal[5],2)), 
            hjust = 1.015, vjust = 1.5, col = "Black") 
(m.c + m.m + m.w) / (f.c + f.m + f.w)
ggsave(filename = "figures/Weight_Wing.png", device = "png", dpi = 300,
       width = 6, height = 4, units = "in")
```

#### Treatment effects on body condition 

First, visualising raw data 

```{r} 
g1_t1 <- ggplot(malarone.data) +
  aes(Treatment, body_condition.1) +
  geom_hline(yintercept = mean(malarone.data$body_condition.1, na.rm = T), linetype = "dashed") +
  geom_boxplot(color = "black", outlier.shape = NA, size = .5, width = .3, na.rm = T) + 
  geom_jitter(color = 'lightgrey', width = 0.2, height = 0, na.rm = T) +
  stat_n_text(na.rm = T, y.pos = -Inf, vjust = -1) + 
  labs(x = "", y = "Std. body condition index") + 
  stat_summary(fun = mean, colour = c("#1F78B4", "#33A02C", "#FF7F00"), geom = "errorbar", 
               size = 1.5 , width = 0.05, show.legend = FALSE, 
               fun.max = function(x) mean(x) + sd(x),
               fun.min = function(x) mean(x) - sd(x), na.rm = T) +
  stat_summary(fun = mean, colour = c("#1F78B4", "#33A02C", "#FF7F00"), geom = "point", 
               size = 5 ,show.legend = FALSE, na.rm = T) + 
  theme_article() +
  theme(legend.position = "none",
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_y_continuous(limits = c(-4.5, 4.75), breaks = seq(-4, 4, 1)) +
  ggtitle("1st sampling")


g1_t2 <- ggplot(malarone.data) + 
  aes(Treatment, body_condition.2) + 
  geom_hline(yintercept = mean(malarone.data$body_condition.2, na.rm = T), linetype = "dashed") + 
  geom_boxplot(color = "black", outlier.shape = NA, size = .5, width = .3, na.rm = T) + 
  geom_jitter(color = 'lightgrey', width = 0.2, height = 0, na.rm = T) +
  stat_n_text(na.rm = T, y.pos = -Inf, vjust = -1) + 
  labs(x = "", y = "Std. body condition index") + 
  stat_summary(fun = mean, colour = c("#1F78B4", "#33A02C", "#FF7F00"), geom = "errorbar", 
               size = 1.5 , width = 0.05, show.legend = FALSE, 
               fun.max = function(x) mean(x) + sd(x),
               fun.min = function(x) mean(x) - sd(x), na.rm = T) + 
  stat_summary(fun = mean, colour = c("#1F78B4", "#33A02C", "#FF7F00"), geom = "point", 
               size = 5 ,show.legend = FALSE, na.rm = T) +  
  theme_article() +
  theme(legend.position = "none",
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_y_continuous(limits = c(-4.5, 4.75), breaks = seq(-4, 4, 1)) +
  ggtitle("2nd sampling")

g1_delta <- ggplot(malarone.data) + 
  aes(Treatment,delta_body_condition) + 
  geom_hline(yintercept = mean(malarone.data$delta_body_condition, na.rm = T), linetype = "dashed") + 
  geom_boxplot(color = "black", outlier.shape = NA, size = .5, width = .3, na.rm = T) + 
  geom_jitter(color = 'lightgrey', width = 0.2, height = 0, na.rm = T) +
  stat_n_text(na.rm = T, y.pos = -Inf, vjust = -1) + 
  labs(x = "", y = "\U0394 Std. body condition index") + 
  stat_summary(fun = mean, colour = c("#1F78B4", "#33A02C", "#FF7F00"), geom = "errorbar", 
               size = 1.5 , width = 0.05, show.legend = FALSE, 
               fun.max = function(x) mean(x) + sd(x),
               fun.min = function(x) mean(x) - sd(x), na.rm = T) + 
  stat_summary(fun = mean, colour = c("#1F78B4", "#33A02C", "#FF7F00"), geom = "point", 
               size = 5 ,show.legend = FALSE, na.rm = T) +  
  theme_article() +
  theme(legend.position = "none",
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_y_continuous(limits = c(-4.5, 4.75), breaks = seq(-4, 4, 1)) +
  ggtitle("\U0394 BCI")

g1_t1 + g1_t2 + g1_delta + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 14))
```

As shown above, there was some heterogeneity among treatment in the mean body condition index before treatment. Therefore, we used the change in body condition ($\Delta (2nd~sample - 1st~sample$)  

```{r}
## Run LMM
## -----------------------------------------------------------------------------
model.bci <- lmerTest::lmer(delta_body_condition ~ Treatment + avg_age + days_resample + Year + (1|Nest),
                  data = malarone.data)

## Summarise model
## -----------------------------------------------------------------------------
summary.model <- summary(model.bci)[["coefficients"]]
pander::pandoc.table(summary.model)

## Check model assumptions
## -----------------------------------------------------------------------------
performance::check_model(model.bci)
performance::model_performance(model.bci)

## Predicted values for each treatment
## -----------------------------------------------------------------------------
pred.bci <- get_model_data(model.bci, type = 'pred', terms = "Treatment") %>% 
  mutate(x = factor(x = c("control","water","Malarone®"), levels = c("control","water","Malarone®")))

## add sample size to labels
## -----------------------------------------------------------------------------
n <- table(malarone.data$Treatment[!is.na(malarone.data$delta_body_condition)])
pred.bci <- pred.bci %>% 
  mutate(x = paste0(x,"\nn=",n))

## Plot:
## 1.) predictions and corresponding error margins
## 2.) indicate significant differences based on tukey contrasts
## 3.) Jitter not fitting as corrected for considerable among-year variation
## -----------------------------------------------------------------------------
g1_pred_delta <- ggplot(pred.bci, aes(x = x, y = predicted)) +
  # geom_hline(yintercept = mean(pred.bci$predicted, na.rm = T), linetype = "dashed") + 
  labs(x = "", y = "\U0394 body condition\n(z-transformed)") + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), colour = 'black', size = 1.5, width = .1) +
  geom_errorbar(aes(ymin = predicted - std.error, ymax = predicted + std.error) ,
                size = 8, colour = c("#1F78B4", "#33A02C", "#FF7F00"), width = 0) +
  geom_point(color = "black", size = 2) +
  scale_y_continuous(breaks = seq(0, 0.6, 0.1), limits = c(-0.06, 0.64)) +
  theme_article(base_size = 12) + 
  theme(legend.position = "none",
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm"))
```


#### Growth rate between control and Malarone® treated nestlings


Visualising the raw data

```{r} 
g2_water <- ggplot(malarone.data, aes(Treatment, growth_rate)) +
  geom_hline(yintercept = mean(malarone.data$growth_rate, na.rm = T), linetype = "dashed") + 
  geom_boxplot(color = "black", outlier.shape = NA, size = .5, width = .3, na.rm = T) + 
  geom_jitter(color = 'lightgrey', width = 0.2, height = 0, na.rm = T) + 
  stat_n_text(na.rm = T, y.pos = -Inf, vjust = -1) +
  labs(x = "", y = "Std. growth rate") + 
  stat_summary(fun = mean, colour = c("#1F78B4", "#33A02C", "#FF7F00"), geom = "errorbar", 
               size = 1.5 , width = 0.05, show.legend = FALSE, 
               fun.max = function(x) mean(x) + sd(x),
               fun.min = function(x) mean(x) - sd(x), na.rm = T) + 
  stat_summary(fun = mean, colour = c("#1F78B4", "#33A02C", "#FF7F00"), geom = "point", 
               size = 5 ,show.legend = FALSE, na.rm = T) + 
  theme_article() + 
  theme(legend.position = "none",
        axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm"))
```

Modelling treatment effects while controlling for age and year-specific variation

```{r}
## Here, scaling is IMPORTANT
lmer_gr_treat <- lmerTest::lmer(growth_rate ~ Treatment + avg_age + days_resample + Sex + Year + (1|Nest),
                                data = malarone.data)

## Summarise model
## -----------------------------------------------------------------------------
summary.model <- summary(lmer_gr_treat)[["coefficients"]]
pander::pandoc.table(summary.model)


## Check model assumptions: okayish
## -----------------------------------------------------------------------------
performance::check_model(lmer_gr_treat)
performance::model_performance(lmer_gr_treat)

## Predicted values for each treatment
## -----------------------------------------------------------------------------
mod_gr <- get_model_data(lmer_gr_treat,type='pred',terms="Treatment") %>% 
   mutate(x = factor(c("control","water","Malarone®"), levels = c("control","water","Malarone®")))

## add sample size to labels
## -----------------------------------------------------------------------------
n <- table(malarone.data$Treatment[!is.na(malarone.data$growth_rate)])
mod_gr <- mod_gr %>% 
  mutate(x = paste0(x,"\nn=",n))

g2_pred <- ggplot(mod_gr, aes(x = x, y = predicted)) +
    # geom_hline(yintercept = mean(mod_gr$predicted, na.rm = T), linetype = "dashed") +
    labs(x = "", y = "growth rate [g/day]\n(z-transformed)") + 
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), colour = 'black', size = 1.5, width = .1) + 
    geom_errorbar(aes(ymin = predicted - std.error , ymax = predicted + std.error),
                  size = 8, colour = c("#1F78B4", "#33A02C", "#FF7F00"), width = 0) + 
    geom_point(color = "black", size = 2) + 
    theme_article(base_size = 12) + 
    theme(legend.position = "none", 
          axis.line.x = element_blank(), 
          axis.ticks.x = element_blank(),
          plot.margin = margin(0, 0, 0, 0, "cm")) 
  scale_y_continuous(breaks = seq(0, 0.6, 0.1), limits = c(-0.06, 0.64))
```

### `Bloodchemistry`
#### Comparing parameter distributions among groups

First, visualising raw data 

```{r, warning=FALSE, message=FALSE, results='hide'}
## A: Age
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(Age),
            SD = sd(Age),
            LCL = quantile(Age, 0.025),
            UCL = quantile(Age, 0.975))
A <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = Age),
              height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data,
            aes(y = Age, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "A") +
  scale_y_continuous(breaks = seq(15, 40, 5)) +
  ylab("Nestling age\n(days)")

## B: Body condition index
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(BCI),
            SD = sd(BCI),
            LCL = quantile(BCI, 0.025),
            UCL = quantile(BCI, 0.975))
B <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = BCI), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = BCI, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "B") +
  scale_y_continuous(breaks = seq(-100, 200, 50)) +
  ylab("Body condition index\n")

## C: Leucocytozoon
## -----------------------------------------------------------------------------
# means <- bloodchem.data %>% 
#   group_by(Treatment) %>%
#   summarise(MEAN = mean(Leucocytozoon),
#             SD = sd(Leucocytozoon),
#             LCL = quantile(Leucocytozoon, 0.025),
#             UCL = quantile(Leucocytozoon, 0.975))
# C <-
#   ggplot(means, aes(x = Treatment, y = MEAN)) +
#   theme_article(base_size = 10) +
#   theme(
#     legend.position = "none",
#     axis.text.x = element_blank(),
#     axis.ticks.x = element_blank(),
#     axis.title.x = element_blank()) +
#   scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
#   geom_errorbar(aes(ymin = LCL, ymax = UCL),
#                 width = 0.1, size = 1) +
#   geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
#                 width = 0, size = 8) +
#   geom_point(size = 2) +
#   geom_jitter(data = bloodchem.data, aes(y = Leucocytozoon), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
#   geom_line(data = bloodchem.data, aes(y = Leucocytozoon, group = Ring), col = "Black", lty = "dotted") +
#   labs(tag = "C") +
#   scale_y_continuous(breaks = seq(0, 4, 1)) +
#   ylab("Leucocytozoon\ninfection intensity")

## D: AP
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(AP),
            SD = sd(AP),
            LCL = quantile(AP, 0.025),
            UCL = quantile(AP, 0.975))
C <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = AP), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = AP, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "C") +
  ylab("AP\n(U/I)")

## D: AST
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(AST),
            SD = sd(AST),
            LCL = quantile(AST, 0.025),
            UCL = quantile(AST, 0.975))
D <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = AST), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = AST, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "D") +
  ylab("AST\n(U/I)")


## E: GGT
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(GGT),
            SD = sd(GGT),
            LCL = quantile(GGT, 0.025),
            UCL = quantile(GGT, 0.975))
E <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = GGT), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = GGT, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "E") +
  ylab("GGT\n(U/I)")

## F: BuChE
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(BuChE),
            SD = sd(BuChE),
            LCL = quantile(BuChE, 0.025),
            UCL = quantile(BuChE, 0.975))
F <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = BuChE), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = BuChE, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "F") +
  ylab("BuChE\n(KU/I)")

## G: BA
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(BA),
            SD = sd(BA),
            LCL = quantile(BA, 0.025),
            UCL = quantile(BA, 0.975))
G <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = BA), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = BA, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "G") +
  ylab("BA\n(µmol/L)")

## H: LDH
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(LDH),
            SD = sd(LDH),
            LCL = quantile(LDH, 0.025),
            UCL = quantile(LDH, 0.975))
H <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = LDH), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = LDH, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "H") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ylab("LDH\n(U/I)")

## I: CK
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(CK),
            SD = sd(CK),
            LCL = quantile(CK, 0.025),
            UCL = quantile(CK, 0.975))
I <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = CK), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = CK, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "I") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ylab("CK\n(U/I)")

## J: ALB
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(ALB),
            SD = sd(ALB),
            LCL = quantile(ALB, 0.025),
            UCL = quantile(ALB, 0.975))
J <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
        legend.position = "none",
        axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = ALB), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = ALB, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "J") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ylab("ALB\n(g/L)")

## K: TP
## -----------------------------------------------------------------------------
means <- bloodchem.data %>% 
  group_by(Treatment) %>%
  summarise(MEAN = mean(TP),
            SD = sd(TP),
            LCL = quantile(TP, 0.025),
            UCL = quantile(TP, 0.975))
K <-
  ggplot(means, aes(x = Treatment, y = MEAN)) +
  theme_article(base_size = 10) +
  theme(
    aspect.ratio = 1,
    legend.position = "none",
    axis.title.x = element_blank()) +
  scale_color_manual(values = c("#A6CEE3", "#1F78B4", "#FDBF6F", "#FF7F00")) +
  geom_errorbar(aes(ymin = LCL, ymax = UCL),
                width = 0.1, size = 1) +
  geom_errorbar(aes(col = Treatment, ymin = MEAN - SD, ymax = MEAN + SD),
                width = 0, size = 8) +
  geom_point(size = 2) +
  geom_jitter(data = bloodchem.data, aes(y = TP), height = 0, size = 0.8, alpha = .6, width = .2, shape = 1) +  
  geom_line(data = bloodchem.data, aes(y = TP, group = Ring), col = "Black", lty = "dotted") +
  labs(tag = "K") +
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) +
  ylab("TP\n(g/L)")
```


#### Testing for among group differences

Data are not normally distributed, and thus all group comparisons are performed using non-parametric tests, i.e., Wilcoxon signed rank test for paired data and Mann-Whitney test for unpaired data.

The following function is defined to estimate these statistics for all parameters:

```{r}
## function to compute paired and unpaired tests
## -----------------------------------------------------------------------------
u_test <- function(var = NULL, x_name = "Post-Mal", y_name = "Post-Control", 
                   paired = FALSE) {
  
  ## Get data of groups to compare
  ## ---------------------------------------------------------------------------
  x <- bloodchem.data[[var]][bloodchem.data$Treatment == x_name]
  y <- bloodchem.data[[var]][bloodchem.data$Treatment == y_name]
  
  ## Run test and retrun results  
  ## ---------------------------------------------------------------------------
  u <- wilcox.test(x, y, paired = paired)
  
  return(data.frame(parameter = var, 
                    group_x = x_name,
                    group_y = y_name,
                    U_value = u$statistic,
                    p_value = u$p.value))
}
```

Apply the function to all comparisons of interest

```{r, warning=FALSE}
## Unpaired tests 
## -----------------------------------------------------------------------------
u_tests <- rbind(
  ## 1.) Pre-Control vs Pre-Mal, unpaired 
  lapply(names(bloodchem.data)[c(4:7, 9:13)], u_test, 
         x_name = "Pre-Control", y_name = "Pre-Mal") %>% 
    do.call("rbind",.) %>%
    mutate(p_value_adj = p.adjust(p_value, method = "BH")),
  ## 2.) Post-Control vs Post-Mal, unpaired
  lapply(names(bloodchem.data)[c(4:7, 9:13)], u_test, 
         x_name = "Post-Control", y_name = "Post-Mal") %>% 
    do.call("rbind",.) %>%
    mutate(p_value_adj = p.adjust(p_value, method = "BH"))
)
write.csv(u_tests, file = "data/u_tests.csv")
knitr::knit_print(u_tests)

## Paired tests
## -----------------------------------------------------------------------------
w_tests <- lapply(names(bloodchem.data)[c(4:7, 9:13)], u_test, paired = T,
                  x_name = "Pre-Mal", y_name = "Post-Mal") %>% 
  do.call("rbind",.) %>%
  mutate(p_value_adj = p.adjust(p_value, method = "BH"))
write.csv(w_tests, file = "data/w_tests.csv")
knitr::knit_print(w_tests)
```

## Summary
### Model table

```{r, warning=FALSE, message=FALSE}
sjPlot::tab_model(
  model.bci,lmer_gr_treat,
  show.ci50 = T ,
  show.stat = T,
  show.reflvl = T,
  string.stat = "t",
  p.val = "kr",
  dv.labels = c("Std. body condition","Std. growth rate"))
```

### Multiplots

```{r}
## Malarone® experiment
## -----------------------------------------------------------------------------
g1_pred_delta + g2_pred + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 14))
ggsave(filename = "figures/MalaroneMultiplot.png", device = "png", dpi = 300,
       width = 6, height = 4, units = "in")

## Bloodchemistry data
## -----------------------------------------------------------------------------
A + B + C + D + E + F + G + H + I + J + K + plot_spacer() +  plot_layout(ncol = 3)
ggsave(filename = "figures/BloodChemistryMultiplot.png", device = "png", dpi = 300,
       width = 9, height = 6, units = "in")
```

### Supplementary analses

Calculating effective Malarone® dose per individual, corrected for body mass:

```{r}
malarone.data <- malarone.data %>% 
  mutate(dose = case_when(Treatment == "Malarone®" ~ 7/Weight.1*100,
                          Treatment == "control" ~ 0,
                          Treatment == "water" ~ 0))
```

Testing for a linear effect of individual-specific Malarone® dose

```{r}
model.bci.mal <- lmerTest::lmer(delta_body_condition ~ dose + avg_age + days_resample + Year + (1|Nest),
                                data = filter(malarone.data, Treatment == "Malarone®"))

## Summarise model
## -----------------------------------------------------------------------------
summary.model <- summary(model.bci.mal)[["coefficients"]]
pander::pandoc.table(summary.model)

## Predicted values for each treatment
## -----------------------------------------------------------------------------
mod_bci <- get_model_data(model.bci.mal,type='pred',terms="dose")

ggplot(mod_bci, aes(x = x, y = predicted)) +
  labs(x = "Malarone® dose [mg/kg]", y = "\U0394 body condition\n(z-transformed)") + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), colour = 'grey25', size = 1.5, width = .1) + 
  geom_point(color = "red", size = 2) + 
  theme_article(base_size = 12) + 
  theme(legend.position = "none", 
        axis.line.x = element_blank(), 
        axis.ticks.x = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm")) 
ggsave(filename = "figures/BodyCondition_Dose.png", device = "png", dpi = 300,
       width = 6, height = 6, units = "in")
```

```{r}
lmer_gr_treat.mal <- lmerTest::lmer(growth_rate ~ dose + avg_age + days_resample + Sex + Year + (1|Nest),
                                data = filter(malarone.data, Treatment == "Malarone®"))

## Summarise model
## -----------------------------------------------------------------------------
summary.model <- summary(lmer_gr_treat.mal)[["coefficients"]]
pander::pandoc.table(summary.model)

## Predicted values for each treatment
## -----------------------------------------------------------------------------
mod_gr <- get_model_data(lmer_gr_treat.mal,type='pred',terms="dose", )

ggplot(mod_gr, aes(x = x, y = predicted)) +
  labs(x = "Malarone® dose [mg/kg]", y = "growth rate [g/day]\n(z-transformed)") + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), colour = 'grey25', size = 1.5, width = .1) + 
  geom_point(color = "red", size = 2) + 
  theme_article(base_size = 12) + 
  theme(legend.position = "none", 
        axis.line.x = element_blank(), 
        axis.ticks.x = element_blank(),
        plot.margin = margin(0, 0, 0, 0, "cm")) 
ggsave(filename = "figures/GrowthRate_Dose.png", device = "png", dpi = 300,
       width = 6, height = 6, units = "in")
```


```{r}
sessionInfo()
```

